<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOEN_LLM::SIBYL_SYSTEM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- SIBYL SYSTEM Theme --- */
        body {
            background-color: #d8e2e8;
            color: #0f1923;
            font-family: 'Share Tech Mono', monospace;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        .chat-container {
            width: 95%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background-color: #f0f4f8;
            border: 1px solid #b0c4d4;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .header { 
            flex-shrink: 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
            border-bottom: 1px solid #b0c4d4;
            background-color: #ffffff;
        }
        .header h1 { 
            font-size: 1.1rem; 
            margin: 0;
            color: #333;
        }
        .controls { display: flex; align-items: center; gap: 10px; }
        .select-wrapper { position: relative; }
        select { 
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding: 8px 30px 8px 12px; 
            cursor: pointer; 
            background-color: #ffffff; 
            border: 1px solid #b0c4d4; 
            color: #0f1923; 
            font-family: 'Share Tech Mono', monospace; 
            border-radius: 2px; 
            transition: all 0.2s ease; 
        }
        .select-wrapper::after { content: '▼'; font-size: 12px; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); pointer-events: none; color: #555; }
        #new-chat-button { padding: 8px 12px; cursor: pointer; background-color: #ffffff; border: 1px solid #b0c4d4; color: #0f1923; font-family: 'Share Tech Mono', monospace; border-radius: 2px; transition: all 0.2s ease; }
        select:hover, #new-chat-button:hover { background-color: #e8f0f5; border-color: #00aaff; }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; }
        .message-sender { 
            font-weight: normal; 
            margin-bottom: 5px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9em;
            color: #555;
        }
        .ai-icon { width: 20px; height: 20px; }
        .message-content { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            line-height: 1.7; 
            background: #ffffff; 
            padding: 15px; 
            border: 1px solid #d0e0ea; 
            position: relative; 
            border-radius: 3px;
        }
        .message-content strong { color: #007acc; }
        .input-container { flex-shrink: 0; padding: 15px; border-top: 1px solid #b0c4d4; background-color: #ffffff; }
        .input-area { display: flex; gap: 10px; align-items: center; }
        textarea { 
            flex-grow: 1; 
            resize: none; 
            max-height: 150px; 
            background-color: #ffffff; 
            border: 1px solid #b0c4d4; 
            color: #0f1923; 
            font-family: 'Share Tech Mono', monospace; 
            border-radius: 2px; 
            padding: 10px;
            transition: all 0.2s ease;
        }
        textarea:focus {
            outline: none;
            border-color: #00aaff;
            box-shadow: 0 0 5px rgba(0, 170, 255, 0.3);
        }
        .button { 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            background: #f0f4f8; 
            border: 1px solid #b0c4d4; 
            border-radius: 2px; 
            transition: all 0.2s ease; 
        }
        .button svg { width: 20px; height: 20px; fill: #555; transition: all 0.2s ease; }
        .button:hover { background-color: #e8f0f5; border-color: #00aaff; }
        .button:hover svg { fill: #00aaff; }
        #send-button { background: #00aaff; border-color: #00aaff; }
        #send-button:hover { background: #007acc; }
        #send-button svg { fill: white; }
        .copy-button { position: absolute; bottom: 8px; right: 8px; cursor: pointer; padding: 2px 6px; font-size: 0.7rem; opacity: 0; transition: opacity 0.3s; background: #e8f0f5; border: 1px solid #b0c4d4; color: #555; border-radius: 2px; }
        .message.ai:hover .copy-button { opacity: 1; }
        .copy-button:hover { background-color: #d0e0ea; }
        pre { background-color: #f0f4f8; border: 1px solid #d0e0ea; color: #333; padding: 10px; border-radius: 3px; position: relative; }
        .copy-code-button { position: absolute; top: 8px; right: 8px; cursor: pointer; padding: 3px 8px; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; background: #e8f0f5; border: 1px solid #b0c4d4; color: #555; border-radius: 2px; }
        .message-content pre:hover .copy-code-button { opacity: 1; }
        .copy-code-button:hover { background-color: #d0e0ea; }
    </style>
</head>
<body class="theme-sibyl">

    <div class="chat-container" id="chat-container">
        <div class="header">
            <h1>[GOEN_LLM::SIBYL_SYSTEM]</h1>
            <div class="controls">
                <div class="select-wrapper">
                    <select id="model-selector">
                        <option value="gemma3:4b">Gemma3 4B (Default)</option>
                        <option value="gemma3:12b">Gemma3 12B</option>
                        <option value="llama3:latest">Llama 3</option>
                    </select>
                </div>
                <button id="new-chat-button">::NEW_SESSION::</button>
            </div>
        </div>
        <div class="chat-history" id="chat-history"></div>
        <div class="input-container">
            <div class="input-area">
                <textarea id="prompt-input" rows="1" placeholder="> ANALYZE_INPUT..."></textarea>
                <button id="send-button" class="button" title="Execute">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const sendButton = document.getElementById('send-button');
        const promptInput = document.getElementById('prompt-input');
        const chatHistory = document.getElementById('chat-history');
        const modelSelector = document.getElementById('model-selector');
        const newChatButton = document.getElementById('new-chat-button');

        // --- State ---
        let conversationHistory = [];

        // --- SVG Icon Data ---
        const characterData = {
            haku: {
                name: "HAKU",
                icon: `<svg class="ai-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M50,20 A30,28 0,1,1 50,76 A30,28 0,1,1 50,20" /><path d="M25,52 A25,25 0,0,0 75,52" /><ellipse cx="38" cy="45" rx="5" ry="6" fill="currentColor"/><ellipse cx="62" cy="45" rx="5" ry="6" fill="currentColor"/><path d="M40,62 Q50,68 60,62" /></svg>`
            }
        };

        // --- Event Listeners ---
        sendButton.addEventListener('click', generateResponse);
        newChatButton.addEventListener('click', () => {
            chatHistory.innerHTML = '';
            conversationHistory = [];
        });
        
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = (promptInput.scrollHeight) + 'px';
        });

        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                generateResponse();
            }
        });
        document.addEventListener('paste', async (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            promptInput.value += text;
        });

        // --- Chat Logic ---
        function isCommand(text) {
            const commands = ['教えて', '作って', '考えて', 'ください', 'とは', '何ですか', '?', '？'];
            return commands.some(cmd => text.includes(cmd)) || text.endsWith('か');
        }

        function addMessageToHistory(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const senderDiv = document.createElement('div');
            senderDiv.className = `message-sender ${sender}`;
            
            if (sender === 'ai') {
                const char = characterData.haku;
                senderDiv.innerHTML = char.icon + `<span>// ${char.name}_RESPONSE</span>`;
            } else {
                senderDiv.textContent = `// USER_INPUT`;
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const textNode = document.createElement('span');
            textNode.className = 'ai-response-text';
            textNode.innerHTML = marked.parse(text);
            contentDiv.appendChild(textNode);

            if (sender === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-button';
                copyBtn.textContent = 'COPY';
                contentDiv.appendChild(copyBtn);
            }

            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(contentDiv);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            if (sender === 'ai') {
                addCodeCopyButtons(contentDiv);
            }

            return contentDiv;
        }
        
        function addCodeCopyButtons(element) {
            const codeBlocks = element.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                const btn = document.createElement('button');
                btn.className = 'copy-code-button';
                btn.textContent = 'Copy Code';
                btn.onclick = () => {
                    const code = block.querySelector('code').innerText;
                    navigator.clipboard.writeText(code);
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Code'; }, 2000);
                };
                block.appendChild(btn);
            });
        }

        async function generateResponse() {
            let prompt = promptInput.value.trim();
            if (!prompt) return;

            sendButton.disabled = true;
            promptInput.value = '';
            promptInput.style.height = 'auto';
            
            addMessageToHistory('user', prompt);

            const isProofreadMode = !isCommand(prompt);
            
            let systemPrompt = null;
            if (isProofreadMode) {
                systemPrompt = { role: 'system', content: 'あなたは文章校正のエキスパートです。提示された文章を分析し、より良くするための修正案とその理由を簡潔に提示してください。' };
            }

            const userMessage = { role: 'user', content: prompt };
            
            const messages = [...conversationHistory];
            if (systemPrompt) {
                messages.push(systemPrompt);
            }
            messages.push(userMessage);

            const aiMessageContent = addMessageToHistory('ai', '...');
            
            const payload = {
                model: modelSelector.value,
                messages: messages,
                stream: true
            };

            try {
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                aiMessageContent.querySelector('.ai-response-text').innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    lines.forEach(line => {
                        if (line) {
                            try {
                                const parsed = JSON.parse(line);
                                fullResponse += parsed.message.content;
                                aiMessageContent.querySelector('.ai-response-text').innerHTML = marked.parse(fullResponse);
                            } catch(e) { console.error("JSON parsing error:", e); }
                        }
                    });
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
                
                conversationHistory.push(userMessage);
                conversationHistory.push({ role: 'assistant', content: fullResponse });
                
                addCodeCopyButtons(aiMessageContent);
                const mainCopyBtn = aiMessageContent.querySelector('.copy-button');
                if(mainCopyBtn) {
                    mainCopyBtn.onclick = () => {
                        navigator.clipboard.writeText(fullResponse);
                        mainCopyBtn.textContent = 'COPIED!';
                        setTimeout(() => { mainCopyBtn.textContent = 'COPY'; }, 2000);
                    };
                }

            } catch (error) {
                aiMessageContent.querySelector('.ai-response-text').textContent = '>> CRITICAL_ERROR\n' + error;
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
            }
        }
    </script>
</body>
</html>
